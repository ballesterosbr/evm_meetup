# evm_meetup

## Intro

La máquina virtual Ethereum (EVM) es el entorno de tiempo de ejecución (runtime) para contratos inteligentes en Ethereum. Se encuentra aislado, lo que significa que el código que se ejecuta dentro de la EVM no tiene acceso a la red, sistema de archivos u otros procesos de la blockchain.

Los contratos viven en la cadena de bloques en un formato binario específico de Ethereum (EVM bytecode). Sin embargo, los contratos generalmente se escriben en un lenguaje de alto nivel de Ethereum, se compilan en bytecode usando un compilador de EVM y finalmente se cargan en la cadena de bloques utilizando un cliente de Ethereum. Los contratos inteligentes pueden tener acceso limitado a otros contratos inteligentes.

---

Proporcionar seguridad y ejecución de código no confiable en ordenadores de todo el mundo.

- Prevenir denegación de servicios (DDoS)
- Asegurar que programas no tienen acceso al estado de otros
- Asegurar que no haya interferencias

Para hacer todo esto de una forma segura se imponen las siguientes restricciones:
- Cada paso computacional que se realice en la ejecución de un programa debe ser pagado por adelantado (Gas). --> DDoS protection

- Los programas sólo interactuan a través de la transmisión de matrices de datos únicas. --> No acceden a otros programas.

- La ejecución de programas es en modo sandbox. Un programa puede alterar su propio estado y acceder al mismo, además puede lanzar la ejecución de otro programa, pero nada más. --> No accede al estado de otros programas.

- La ejecución del programa es completamente determinista y por lo tanto produce transiciones de estado idénticas para un estado de comienzo idntico.

---

Cada nodo contiene su propia implementación de la EVM capaz de ejecutar las mismas operaciones, lo que facilita la labor de desarrolladores a la hora de tener un entorno de pruebas.

Es una puerta de acceso a la creación de smart contracts en Solidity, pero también la EVM se ha implementado en Python, Ruby, C++ y otros lenguajes.

------------------------

Interpretación de valores binarios de 256-bits como enteros. Cuando un dato de 256-bits se convierte hacia o desde una address o hash de 160-bits, se conservan los 20 bytes más a la derecha mientras que los otros 12 bytes se descartan o se rellenan con ceros.

Aclaración big endian --> MSB to LSB
```
13 --> 0x3133 
trece --> 0x74726563650d0a
``` 

---

Se podría decir que la EVM es una cuasi máquina de Turing; "cuasi" por el hecho de que la computación está intrínsecamente limitada por un factor, el Gas, que limita la cantidad total de cálculo.

---

Basics

- Arquitectura basada en pila.
- Tamaño de palabra de 256-bits. --> Tamaño de elemento de pila 256-bits
- El modelo de memoria es una matriz de bytes (word-addressed byte array)
- Basado para facilitar el esquema la función keccack-256 y cálculos de curva elíptica.
- Tamaño máximo de la pila: 1024.
- Modelo de almacenamiento independiente: es una matriz de palabras direccionables (word addressable word array)

---

A diferencia de la memoria, que es volátil, el almacenamiento no es volátil y se mantiene como parte del estado del sistema. Todas las ubicaciones de almacenamiento y memoria están definidas inicialmente como cero.

La máquina no sigue la arquitectura estándar de la máquina de von Neumann

En lugar de almacenar el código del programa en una memoria o almacenamiento accesible, se almacena en una ROM virtual con la cual sólo se puede interactuar a través de una instrucción especializada.

---

Pueden suceder excepciones por varias razones, desbordamientos de pila, instrucciones no válidas. Una excepción bastante común suele ser "out-of-gas (OOG)" que no deja los cambios de estado intactos.

La máquina se detiene inmediatamente e informa el problema al procesador de transacciones o, recursivamente, al entorno agente de ejecución (ya sea el procesador de transacciones o, recursivamente, el entorno de ejecución que controlará la excepción.

---

La EVM es una máquina virtual basada en pila con una matriz de bytes de memoria y almacenamiento de clave-valor. Los elementos en la pila son palabras de 32 bytes, y todas las claves y valores almacenados son de 32 bytes. Hay más de 100 códigos de operación, divididos en categorías delineadas en múltiplos de 16. Se puede consultar aquí:


```python
# schema: [opcode, ins, outs, gas]

[opcode,
elementos que entran a la pila,
elementos que salen de la pila,
costa en gas]

opcodes = {

    # arithmetic
    0x00: ['STOP', 0, 0, 0],
    0x01: ['ADD', 2, 1, 3],
    0x02: ['MUL', 2, 1, 5],
    0x03: ['SUB', 2, 1, 3],
    0x04: ['DIV', 2, 1, 5],
    0x05: ['SDIV', 2, 1, 5],
    0x06: ['MOD', 2, 1, 5],
    0x07: ['SMOD', 2, 1, 5],
    0x08: ['ADDMOD', 3, 1, 8],
    0x09: ['MULMOD', 3, 1, 8],
    0x0a: ['EXP', 2, 1, 10],
    0x0b: ['SIGNEXTEND', 2, 1, 5],

    # boolean
    0x10: ['LT', 2, 1, 3],
    0x11: ['GT', 2, 1, 3],
    0x12: ['SLT', 2, 1, 3],
    0x13: ['SGT', 2, 1, 3],
    0x14: ['EQ', 2, 1, 3],
    0x15: ['ISZERO', 1, 1, 3],
    0x16: ['AND', 2, 1, 3],
    0x17: ['OR', 2, 1, 3],
    0x18: ['XOR', 2, 1, 3],
    0x19: ['NOT', 1, 1, 3],
    0x1a: ['BYTE', 2, 1, 3],

    # crypto
    0x20: ['SHA3', 2, 1, 30],
    
    # contract context
    0x30: ['ADDRESS', 0, 1, 2],
    0x31: ['BALANCE', 1, 1, 20],
    0x32: ['ORIGIN', 0, 1, 2],
    0x33: ['CALLER', 0, 1, 2],
    0x34: ['CALLVALUE', 0, 1, 2],
    0x35: ['CALLDATALOAD', 1, 1, 3],
    0x36: ['CALLDATASIZE', 0, 1, 2],
    0x37: ['CALLDATACOPY', 3, 0, 3],
    0x38: ['CODESIZE', 0, 1, 2],
    0x39: ['CODECOPY', 3, 0, 3],
    0x3a: ['GASPRICE', 0, 1, 2],
    0x3b: ['EXTCODESIZE', 1, 1, 20],
    0x3c: ['EXTCODECOPY', 4, 0, 20],

    # blockchain context
    0x40: ['BLOCKHASH', 1, 1, 20],
    0x41: ['COINBASE', 0, 1, 2],
    0x42: ['TIMESTAMP', 0, 1, 2],
    0x43: ['NUMBER', 0, 1, 2],
    0x44: ['DIFFICULTY', 0, 1, 2],
    0x45: ['GASLIMIT', 0, 1, 2],
  
    # storage and execution
    0x50: ['POP', 1, 0, 2],
    0x51: ['MLOAD', 1, 1, 3],
    0x52: ['MSTORE', 2, 0, 3],
    0x53: ['MSTORE8', 2, 0, 3],
    0x54: ['SLOAD', 1, 1, 50],
    0x55: ['SSTORE', 2, 0, 0],
    0x56: ['JUMP', 1, 0, 8],
    0x57: ['JUMPI', 2, 0, 10],
    0x58: ['PC', 0, 1, 2],
    0x59: ['MSIZE', 0, 1, 2],
    0x5a: ['GAS', 0, 1, 2],
    0x5b: ['JUMPDEST', 0, 0, 1],

    # logging
    0xa0: ['LOG0', 2, 0, 375],
    0xa1: ['LOG1', 3, 0, 750],
    0xa2: ['LOG2', 4, 0, 1125],
    0xa3: ['LOG3', 5, 0, 1500],
    0xa4: ['LOG4', 6, 0, 1875],
	
    # arbitrary length storage (proposal for metropolis hardfork)
    0xe1: ['SLOADBYTES', 3, 0, 50],
    0xe2: ['SSTOREBYTES', 3, 0, 0],
    0xe3: ['SSIZE', 1, 1, 50],

    # closures
    0xf0: ['CREATE', 3, 1, 32000],
    0xf1: ['CALL', 7, 1, 40],
    0xf2: ['CALLCODE', 7, 1, 40],
    0xf3: ['RETURN', 2, 0, 0],
    0xf4: ['DELEGATECALL', 6, 0, 40],
    0xff: ['SUICIDE', 1, 0, 0],
}

# push
for i in range(1, 33):
    opcodes[0x5f + i] = ['PUSH' + str(i), 0, 1, 3]

# duplicate and swap
for i in range(1, 17):
    opcodes[0x7f + i] = ['DUP' + str(i), i, i + 1, 3]
    opcodes[0x8f + i] = ['SWAP' + str(i), i + 1, i + 1, 3]
```

---

## Demo

---

### Demo 1 - Simple disasm

Añade dos números de 1 byte cada uno a la pila y los suma.

```
bytecode: 6005600401
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo "6005600401" >> add1 && evm disasm add1 
6005600401
000000: PUSH1 0x05
000002: PUSH1 0x04
000004: ADD
```
EVM:
```
$ evm --debug --codefile add1 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

PUSH1           pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000005

ADD             pc=00000004 gas=9999999994 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000004
00000001  0000000000000000000000000000000000000000000000000000000000000005

STOP            pc=00000005 gas=9999999991 cost=0
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000009
```

Consideraciones:
- Si se quieren sumar más de dos elementos --> Recordad esquema
```python
    0x01: ['ADD', 2, 1, 3],
``` 
- Si se añade un elemento de 2 bytes saltará excepción.

---

### Demo 2 - Simple disasm v.2

Añade dos números de 2 byte cada uno a la pila y los suma.

```
bytecode: 61123461432101
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo "61123461432101" >> add2 && evm disasm add2
61123461432101
000000: PUSH2 0x1234
000003: PUSH2 0x4321
000006: ADD
```
EVM:
```
$ evm --debug --codefile add2 run
#### TRACE ####
PUSH2           pc=00000000 gas=10000000000 cost=3

PUSH2           pc=00000003 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000001234

ADD             pc=00000006 gas=9999999994 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000004321
00000001  0000000000000000000000000000000000000000000000000000000000001234

STOP            pc=00000007 gas=9999999991 cost=0
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000005555
```
---

### Demo 3 - Paso de parámetros como atributos de función.

Suma tres elementos pasados como parámetos.

Input tres elementos de 32 bytes (0x00...05, 0x00...04, 0x00...03)

```
bytecode: 6000356020356040350101
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo "6000356020356040350101" >> add3 && evm disasm add3
6000356020356040350101
000000: PUSH1 0x00
000002: CALLDATALOAD
000003: PUSH1 0x20
000005: CALLDATALOAD
000006: PUSH1 0x40
000008: CALLDATALOAD
000009: ADD
000010: ADD

```
EVM:
```
$ evm --debug --codefile add3 --input 000000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000003 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

CALLDATALOAD    pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

PUSH1           pc=00000003 gas=9999999994 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000005

CALLDATALOAD    pc=00000005 gas=9999999991 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000020
00000001  0000000000000000000000000000000000000000000000000000000000000005

PUSH1           pc=00000006 gas=9999999988 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000004
00000001  0000000000000000000000000000000000000000000000000000000000000005

CALLDATALOAD    pc=00000008 gas=9999999985 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000040
00000001  0000000000000000000000000000000000000000000000000000000000000004
00000002  0000000000000000000000000000000000000000000000000000000000000005

ADD             pc=00000009 gas=9999999982 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000004
00000002  0000000000000000000000000000000000000000000000000000000000000005

ADD             pc=00000010 gas=9999999979 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000007
00000001  0000000000000000000000000000000000000000000000000000000000000005

STOP            pc=00000011 gas=9999999976 cost=0
Stack:
00000000  000000000000000000000000000000000000000000000000000000000000000c
```
---

### Demo 4 - Loop - Ineficiencia.

Loop que disminuye una unidad por cada pasada a un input.

```
bytecode: 6000356000525b600160005103600052600051600657
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo "6000356000525b600160005103600052600051600657" >> testloop && evm disasm testloop
6000356000525b600160005103600052600051600657
000000: PUSH1 0x00
000002: CALLDATALOAD
000003: PUSH1 0x00
000005: MSTORE
000006: JUMPDEST
000007: PUSH1 0x01
000009: PUSH1 0x00
000011: MLOAD
000012: SUB
000013: PUSH1 0x00
000015: MSTORE
000016: PUSH1 0x00
000018: MLOAD
000019: PUSH1 0x06
000021: JUMPI
```
EVM:
```
$ evm --debug --codefile testloop --input 0000000000000000000000000000000000000000000000000000000000000003 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

CALLDATALOAD    pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

PUSH1           pc=00000003 gas=9999999994 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003

MSTORE          pc=00000005 gas=9999999991 cost=6
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000003
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|

JUMPDEST        pc=00000006 gas=9999999985 cost=1
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

PUSH1           pc=00000007 gas=9999999984 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

PUSH1           pc=00000009 gas=9999999981 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

MLOAD           pc=00000011 gas=9999999978 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

SUB             pc=00000012 gas=9999999975 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

PUSH1           pc=00000013 gas=9999999972 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

MSTORE          pc=00000015 gas=9999999969 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000002
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 03  |................|

PUSH1           pc=00000016 gas=9999999966 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

MLOAD           pc=00000018 gas=9999999963 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

PUSH1           pc=00000019 gas=9999999960 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

JUMPI           pc=00000021 gas=9999999957 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000006
00000001  0000000000000000000000000000000000000000000000000000000000000002
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

JUMPDEST        pc=00000006 gas=9999999947 cost=1
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

PUSH1           pc=00000007 gas=9999999946 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

PUSH1           pc=00000009 gas=9999999943 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

MLOAD           pc=00000011 gas=9999999940 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

SUB             pc=00000012 gas=9999999937 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

PUSH1           pc=00000013 gas=9999999934 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

MSTORE          pc=00000015 gas=9999999931 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 02  |................|

PUSH1           pc=00000016 gas=9999999928 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

MLOAD           pc=00000018 gas=9999999925 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

PUSH1           pc=00000019 gas=9999999922 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

JUMPI           pc=00000021 gas=9999999919 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000006
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

JUMPDEST        pc=00000006 gas=9999999909 cost=1
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

PUSH1           pc=00000007 gas=9999999908 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

PUSH1           pc=00000009 gas=9999999905 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

MLOAD           pc=00000011 gas=9999999902 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

SUB             pc=00000012 gas=9999999899 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

PUSH1           pc=00000013 gas=9999999896 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

MSTORE          pc=00000015 gas=9999999893 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 01  |................|

PUSH1           pc=00000016 gas=9999999890 cost=3
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|

MLOAD           pc=00000018 gas=9999999887 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|

PUSH1           pc=00000019 gas=9999999884 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|

JUMPI           pc=00000021 gas=9999999881 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000006
00000001  0000000000000000000000000000000000000000000000000000000000000000
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|

STOP            pc=00000022 gas=9999999871 cost=0
Memory:
00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
```
El anterior código es ineficiente en el uso de la memoria. En su lugar, se puede mantener el elemento en la pila en lugar de la memoria. Además la cantidad de Gas consumida es mucho más elevada que el de a continuación.

```
bytecode: 6000355b6001900380600357
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo "6000355b6001900380600357" >> testloop2 && evm disasm testloop2
6000355b6001900380600357
000000: PUSH1 0x00
000002: CALLDATALOAD
000003: JUMPDEST
000004: PUSH1 0x01
000006: SWAP1
000007: SUB
000008: DUP1
000009: PUSH1 0x03
000011: JUMPI
```
EVM:
```
$ evm --debug --codefile testloop2 --input 0000000000000000000000000000000000000000000000000000000000000003 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

CALLDATALOAD    pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

JUMPDEST        pc=00000003 gas=9999999994 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003

PUSH1           pc=00000004 gas=9999999993 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003

SWAP1           pc=00000006 gas=9999999990 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000003

SUB             pc=00000007 gas=9999999987 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000008 gas=9999999984 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

PUSH1           pc=00000009 gas=9999999981 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000002

JUMPI           pc=00000011 gas=9999999978 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000002
00000002  0000000000000000000000000000000000000000000000000000000000000002

JUMPDEST        pc=00000003 gas=9999999968 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

PUSH1           pc=00000004 gas=9999999967 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

SWAP1           pc=00000006 gas=9999999964 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000002

SUB             pc=00000007 gas=9999999961 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000008 gas=9999999958 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

PUSH1           pc=00000009 gas=9999999955 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

JUMPI           pc=00000011 gas=9999999952 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000001
00000002  0000000000000000000000000000000000000000000000000000000000000001

JUMPDEST        pc=00000003 gas=9999999942 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

PUSH1           pc=00000004 gas=9999999941 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

SWAP1           pc=00000006 gas=9999999938 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

SUB             pc=00000007 gas=9999999935 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000008 gas=9999999932 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

PUSH1           pc=00000009 gas=9999999929 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000000

JUMPI           pc=00000011 gas=9999999926 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000000
00000002  0000000000000000000000000000000000000000000000000000000000000000

STOP            pc=00000012 gas=9999999916 cost=0
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
```
---

### Demo 5 - Inputs de longitud variable en lugar de 32 bytes - (Operador de desplazamiento)

Para tener que evitar introducir elementos de 32 bytes para cada operación, se recurre a la función CALLDATASIZE. Esta función sirve para obtener el tamaño de los datos de entrada. Sustituye a CALLDATALOAD que obtiene los elementos en formato big endian

Por tanto, la finalidad es que 0000000000000000000000000000000000000000000000000000000000000003 pase a ser 03, simulando una operación de desplazamiento común. Matemáticamente, es dividir el input entre 256^(32-L) donde L es el valor del desplazamiento o el tamaño de los datos de entrada.

En este caso lo fijaremos en 0x20 debido a que introduciremos un valor muy pequeño, 03.

La función es la misma que en códigos anteriores, ir reduciendo el valor hasta que se quede a cero.
```
bytecode: 366020036101000a600035045b6001900380600c57
```
Guardar bytecode en archivo para poder ejecutar disasm

```
$ echo  366020036101000a600035045b6001900380600c57 >> shift && evm disasm shift
366020036101000a600035045b6001900380600c57
000000: CALLDATASIZE
000001: PUSH1 0x20
000003: SUB
000004: PUSH2 0x0100
000007: EXP
000008: PUSH1 0x00
000010: CALLDATALOAD
000011: DIV
000012: JUMPDEST
000013: PUSH1 0x01
000015: SWAP1
000016: SUB
000017: DUP1
000018: PUSH1 0x0c
000020: JUMPI
```
EVM:
```
$ evm --debug --codefile shift --input 03 run
#### TRACE ####
CALLDATASIZE    pc=00000000 gas=10000000000 cost=2

PUSH1           pc=00000001 gas=9999999998 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

SUB             pc=00000003 gas=9999999995 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000020
00000001  0000000000000000000000000000000000000000000000000000000000000001

PUSH2           pc=00000004 gas=9999999992 cost=3
Stack:
00000000  000000000000000000000000000000000000000000000000000000000000001f

EXP             pc=00000007 gas=9999999989 cost=60
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000100
00000001  000000000000000000000000000000000000000000000000000000000000001f

PUSH1           pc=00000008 gas=9999999929 cost=3
Stack:
00000000  0100000000000000000000000000000000000000000000000000000000000000

CALLDATALOAD    pc=00000010 gas=9999999926 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0100000000000000000000000000000000000000000000000000000000000000

DIV             pc=00000011 gas=9999999923 cost=5
Stack:
00000000  0300000000000000000000000000000000000000000000000000000000000000
00000001  0100000000000000000000000000000000000000000000000000000000000000

JUMPDEST        pc=00000012 gas=9999999918 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003

PUSH1           pc=00000013 gas=9999999917 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003

SWAP1           pc=00000015 gas=9999999914 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000003

SUB             pc=00000016 gas=9999999911 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000003
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000017 gas=9999999908 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

PUSH1           pc=00000018 gas=9999999905 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000002

JUMPI           pc=00000020 gas=9999999902 cost=10
Stack:
00000000  000000000000000000000000000000000000000000000000000000000000000c
00000001  0000000000000000000000000000000000000000000000000000000000000002
00000002  0000000000000000000000000000000000000000000000000000000000000002

JUMPDEST        pc=00000012 gas=9999999892 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

PUSH1           pc=00000013 gas=9999999891 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

SWAP1           pc=00000015 gas=9999999888 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000002

SUB             pc=00000016 gas=9999999885 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000017 gas=9999999882 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

PUSH1           pc=00000018 gas=9999999879 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

JUMPI           pc=00000020 gas=9999999876 cost=10
Stack:
00000000  000000000000000000000000000000000000000000000000000000000000000c
00000001  0000000000000000000000000000000000000000000000000000000000000001
00000002  0000000000000000000000000000000000000000000000000000000000000001

JUMPDEST        pc=00000012 gas=9999999866 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

PUSH1           pc=00000013 gas=9999999865 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

SWAP1           pc=00000015 gas=9999999862 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

SUB             pc=00000016 gas=9999999859 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000017 gas=9999999856 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

PUSH1           pc=00000018 gas=9999999853 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
00000001  0000000000000000000000000000000000000000000000000000000000000000

JUMPI           pc=00000020 gas=9999999850 cost=10
Stack:
00000000  000000000000000000000000000000000000000000000000000000000000000c
00000001  0000000000000000000000000000000000000000000000000000000000000000
00000002  0000000000000000000000000000000000000000000000000000000000000000

STOP            pc=00000021 gas=9999999840 cost=0
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000
```
---

## Demo 6 - Excepciones

### Out-of-gas (OOG)
Para que se complete la ejecución del programa sería necesaria una cantidad de Gas igual a 9 como se puede observar en la tabla de opcodes. 

```
cost(PUSH1) + cost(PUSH1) + cost(ADD) = 9 > 8 
```

Fijamos una cantidad de Gas a la EVM de 8 y observamos cómo la EVM lanza la excepción:

```
$ evm --debug --gas 8 --code 6005600401 run
#### TRACE ####
PUSH1           pc=00000000 gas=8 cost=3

PUSH1           pc=00000002 gas=5 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000005

ADD             pc=00000004 gas=2 cost=3 ERROR: out of gas
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000004
00000001  0000000000000000000000000000000000000000000000000000000000000005

#### LOGS ####
0x error: out of gas
```
### Invalid opcode
En caso de que durante la ejecución del programa se encuentre con un opcode que la EVM no reconozca saltará excepción.
```
$ evm --debug --code 6005600447 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

PUSH1           pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000005

Missing opcode 0x47pc=00000004 gas=9999999994 cost=3 ERROR: invalid opcode 0x47
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000004
00000001  0000000000000000000000000000000000000000000000000000000000000005

#### LOGS ####
0x error: invalid opcode 0x47
```
### Invalid jump destination

Reutilizamos el código anterior, a la hora de ejecutar JUMPI no encuentra un JUMPDEST y salta excepción.

```Bytecode correcto: 6000355b6001900380600357```

Modificamos la ruta del JUMPI para que salte excepción:
```
$ evm --debug --code 6000355b6001900380600257 --input 0000000000000000000000000000000000000000000000000000000000000002 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

CALLDATALOAD    pc=00000002 gas=9999999997 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000000

JUMPDEST        pc=00000003 gas=9999999994 cost=1
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

PUSH1           pc=00000004 gas=9999999993 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002

SWAP1           pc=00000006 gas=9999999990 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000002

SUB             pc=00000007 gas=9999999987 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000001

DUP1            pc=00000008 gas=9999999984 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001

PUSH1           pc=00000009 gas=9999999981 cost=3
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000001
00000001  0000000000000000000000000000000000000000000000000000000000000001

JUMPI           pc=00000011 gas=9999999978 cost=10
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000002
00000001  0000000000000000000000000000000000000000000000000000000000000001
00000002  0000000000000000000000000000000000000000000000000000000000000001

#### LOGS ####
0x error: invalid jump destination (CALLDATALOAD) 2
```
### Stack underflow
Puede suceder de múltiples formas. En este caso, se intenta eliminar un valor de la pila cuando ya está vacía provocando la excepción.

```
$ evm --debug --code 60055050 run
#### TRACE ####
PUSH1           pc=00000000 gas=10000000000 cost=3

POP             pc=00000002 gas=9999999997 cost=2
Stack:
00000000  0000000000000000000000000000000000000000000000000000000000000005

POP             pc=00000003 gas=9999999995 cost=2 ERROR: stack underflow (0 <=> 1)

#### LOGS ####
0x error: stack underflow (0 <=> 1)
```
